---
title: '查快改慢B+树,改快查慢LSM树'
date: 2019-01-23 11:47:24
tags: [数据结构, mysql, 索引]
categories: [mysql, 数据结构]
---
![](https://bing.ioliu.cn/photo/EyeFireworks_EN-AU4834024020)
## 前言
>书本[**数据结构与算法**]()里面就提到过B树在索引上的应用,而实际应用中一直有许多牛人又对这个数据结构持续做了多优，然这个结构一直有。

---
### 索引文件
数据库的索引其实指的是**索引文件**，而B+树是我们索引文件**储存方式**。用于给存储引擎(这里指innodb)查找指定的数据，这里有必要温习一下数据库查根据where条件查找数据的过程，过程发生在storage engine层：
>1. index Key
    - 首先将index key条件满足的索引记录区间确定，再索引上使用index filter进行过滤
>2. index Filter
    - 将满足的index filter条件的索引记录才去回表取出整行记录返回server层
    - 不满足index filter条件的索引记录丢弃，不回表、也不会返回server层 
>3. Table Filter
>   - 非索引层面的数据过滤，server 层对返回的数据，使用table filter条件做最后的过滤。
---    
### B+树
#### 结构特征
>1. 有序,B+树上层页面中的记录，存储的是下层页面中的最小值(Low Key)；
2. B+树的所有数据，均存储在B+树的叶节点
3. B+树叶节点的所有页面，通过双向链表链接起来
####   优势
>- 支持范围查找，所以需要有序 
- 多叉树结构，降低了索引结构的深度，避免传统二叉树结构中绝大部分的随机访问操作，从而有效减少了磁盘磁头的寻道次数，降低了外存访问延迟对性能的影响本身的时间效率比较高，减少io次数。
- B+树上层页面中的记录，存储的是下层页面中的最小值(Low Key)；
- B+树的所有数据，均存储在B+树的叶节点  
#### 缺点
>- mysql的B+树会在大量的**随机io**的时候性能下降，特别是随机插入，有可能导致多次页分裂，影响整体查询修改效率。
>- 每次的页分裂会导致本页面的空间利用率下降，使得空间利用率向50%靠近。 

---
### LSM树
LSM（Log-Structured Merge-Trees）与B+树相比，牺牲了部分读的性能来换取写的性能(通过批量写入)。 Hbase、LevelDB、rocksDB采用 LSM 树的结构。LSM可以快速建立索引。
#### 结构特征
LSM 是将一个大树拆分成N棵小树，先写到内存（无寻道问题，性能高），在内存中构建一颗有序小树（有序树），随着小树越来越大，内存的小树会flush到磁盘上。当读时，由于不知道数据在哪棵小树上，因此必须遍历（二分查找）所有的小树，但在每颗小树内部数据是有序的。
#### 优势
>- lsm数是基于 
- 多叉树结构，降低了索引结构的深度，避免传统二叉树结构中绝大部分的随机访问操作，从而有效减少了磁盘磁头的寻道次数，降低了外存访问延迟对性能的影响本身的时间效率比较高，减少io次数
- B+树上层页面中的记录，存储的是下层页面中的最小值(Low Key)；
- B+树的所有数据，均存储在B+树的叶节点  
#### 缺点
>- mysql的B+树会在大量的随机**io**的时候性能下降，特别是随机插入，有可能导致多次页分裂，影响查询效率。
- 每次的页分裂会导致页面的空间利用率下降到50% 
#### 优化
>- 布隆过滤器代替二分法查找

